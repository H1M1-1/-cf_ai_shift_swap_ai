<!--
    Shift Swap AI - Intelligent Shift Matching
    
    Author: Haashim Malik
    Created for: Cloudflare 2025 Internship Assignment
    Date: October 2025
    
    Â© 2025 Haashim Malik - All Rights Reserved
    This is original work created for the Cloudflare internship application.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Haashim Malik">
    <meta name="description" content="Shift Swap AI - Cloudflare Workers AI Demo by Haashim Malik">
    <title>Shift Swap AI - Intelligent Shift Matching</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #FAFAFA;
            min-height: 100vh;
            color: #1A1A1A;
            line-height: 1.6;
            margin: 0;
            display: flex;
        }

        /* Left Sidebar */
        .sidebar {
            width: 260px;
            background: #FFFFFF;
            border-right: 1px solid #E8E8E8;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid #E8E8E8;
        }

        .sidebar-brand {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1A1A1A;
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-brand-icon {
            width: 32px;
            height: 32px;
            background: #1A1A1A;
            color: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.875rem;
        }

        .sidebar-nav {
            flex: 1;
            padding: 16px 12px;
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            color: #666666;
            text-decoration: none;
            border-radius: 6px;
            margin-bottom: 4px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .nav-item:hover {
            background: #F5F5F5;
            color: #1A1A1A;
        }

        .nav-item.active {
            background: #F0F0F0;
            color: #1A1A1A;
            font-weight: 600;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
        }

        .sidebar-footer {
            padding: 16px 20px;
            border-top: 1px solid #E8E8E8;
            font-size: 0.75rem;
            color: #999999;
        }

        /* Main Content */
        .main-content {
            margin-left: 260px;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Top Bar */
        .top-bar {
            background: #FFFFFF;
            border-bottom: 1px solid #E8E8E8;
            padding: 16px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .page-title-bar {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1A1A1A;
            letter-spacing: -0.02em;
        }

        .top-bar-actions {
            display: flex;
            gap: 12px;
        }

        /* Container */
        .container {
            flex: 1;
            padding: 32px;
            max-width: 1600px;
        }

        /* Page Header */
        .page-header {
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: #1A1A1A;
            margin-bottom: 8px;
            letter-spacing: -0.03em;
        }

        .page-subtitle {
            font-size: 0.9375rem;
            color: #666666;
            font-weight: 400;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        @media (max-width: 968px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: #FFFFFF;
            border-radius: 12px;
            padding: 28px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #E5E7EB;
        }

        h2 {
            color: #111827;
            margin-bottom: 24px;
            font-size: 1.125rem;
            font-weight: 700;
            letter-spacing: -0.01em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #374151;
            font-size: 0.875rem;
        }

        input, textarea, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            font-size: 0.875rem;
            transition: all 0.2s;
            background: #FFFFFF;
            color: #111827;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        input::placeholder, textarea::placeholder {
            color: #9CA3AF;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        button {
            background: #1A1A1A;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            width: 100%;
        }

        button:hover {
            background: #333333;
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            background: #CCCCCC;
        }

        button.btn-secondary {
            background: #FFFFFF;
            color: #1A1A1A;
            border: 1px solid #D1D5DB;
        }

        button.btn-secondary:hover {
            background: #F5F5F5;
        }

        .shift-list {
            max-height: 600px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .shift-list::-webkit-scrollbar {
            width: 6px;
        }

        .shift-list::-webkit-scrollbar-track {
            background: #F3F4F6;
        }

        .shift-list::-webkit-scrollbar-thumb {
            background: #D1D5DB;
            border-radius: 3px;
        }

        .shift-item {
            background: #FFFFFF;
            border: 1px solid #E8E8E8;
            border-left: 3px solid #1A1A1A;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 8px;
            transition: all 0.15s;
        }

        .shift-item:hover {
            border-left-color: #666666;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .shift-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .shift-user {
            font-weight: 600;
            color: #1A1A1A;
            font-size: 0.9375rem;
        }

        .shift-role {
            background: #F5F5F5;
            color: #1A1A1A;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid #E8E8E8;
        }

        .shift-details {
            color: #6B7280;
            line-height: 1.6;
            font-size: 0.875rem;
        }

        .shift-detail-row {
            margin: 4px 0;
            display: flex;
            gap: 6px;
        }

        .shift-detail-label {
            font-weight: 500;
            color: #374151;
            min-width: 70px;
        }

        .shift-actions {
            margin-top: 12px;
            display: flex;
            gap: 8px;
        }

        .shift-actions button {
            width: auto;
            padding: 8px 14px;
            font-size: 0.8125rem;
        }

        .btn-secondary {
            background: #F3F4F6;
            color: #374151;
            border: 1px solid #D1D5DB;
        }

        .btn-secondary:hover {
            background: #E5E7EB;
            box-shadow: none;
        }

        .match-result {
            background: #ECFDF5;
            border: 1px solid #10B981;
            border-left: 4px solid #10B981;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .match-result h3 {
            color: #065F46;
            margin-bottom: 12px;
            font-size: 1rem;
            font-weight: 600;
        }

        .match-candidate {
            font-size: 1.125rem;
            font-weight: 700;
            color: #047857;
            margin-bottom: 12px;
        }

        .match-reason {
            color: #065F46;
            line-height: 1.6;
            margin-bottom: 16px;
            font-size: 0.875rem;
        }

        .copy-id {
            background: #F3F4F6;
            color: #374151;
            padding: 6px 10px;
            border-radius: 6px;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 0.75rem;
            display: inline-block;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #D1D5DB;
        }

        .copy-id:hover {
            background: #E5E7EB;
            border-color: #9CA3AF;
        }

        .error-message {
            background: #FEF2F2;
            border: 1px solid #FCA5A5;
            border-left: 4px solid #EF4444;
            color: #991B1B;
            padding: 14px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 0.875rem;
        }

        .success-message {
            background: #ECFDF5;
            border: 1px solid #6EE7B7;
            border-left: 4px solid #10B981;
            color: #065F46;
            padding: 14px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 0.875rem;
        }

        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 48px 20px;
            color: #9CA3AF;
        }

        .empty-state-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            opacity: 0.6;
        }

        .empty-state p {
            font-size: 0.875rem;
            color: #6B7280;
        }

        footer {
            text-align: center;
            color: #9CA3AF;
            margin-top: 48px;
            padding: 24px 0;
            font-size: 0.8125rem;
            border-top: 1px solid #E5E7EB;
        }

        footer p {
            margin: 4px 0;
        }

        .info-box {
            background: #EFF6FF;
            border: 1px solid #BFDBFE;
            border-left: 3px solid #3B82F6;
            padding: 14px;
            margin-bottom: 20px;
            border-radius: 6px;
        }

        .info-box-title {
            font-weight: 600;
            color: #1E40AF;
            margin-bottom: 6px;
            font-size: 0.875rem;
        }

        .info-box p {
            color: #1E3A8A;
            font-size: 0.8125rem;
            line-height: 1.5;
        }

        /* Analytics Stats */
        .stat-card {
            background: #FFFFFF;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #E8E8E8;
            text-align: left;
        }

        .stat-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #999999;
            margin-bottom: 8px;
            font-weight: 600;
            letter-spacing: 0.05em;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
            color: #1A1A1A;
        }

        /* Chat Interface */
        .chat-message {
            margin-bottom: 12px;
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .chat-message.user {
            background: #EEF2FF;
            color: #1E40AF;
            text-align: right;
        }

        .chat-message.assistant {
            background: #FFFFFF;
            border: 1px solid #E5E7EB;
            color: #374151;
        }

        .chat-message strong {
            font-weight: 600;
        }

        /* Voice Recording */
        .recording {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Confidence Score */
        .confidence-meter {
            height: 8px;
            background: #E5E7EB;
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #10B981 0%, #059669 100%);
            transition: width 0.5s ease;
        }

        .confidence-label {
            font-size: 0.75rem;
            color: #6B7280;
            font-weight: 600;
        }

        /* Alternative Matches */
        .alt-match {
            background: #F9FAFB;
            border: 1px solid #E5E7EB;
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
            font-size: 0.875rem;
        }

        .alt-match-header {
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
        }

        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #FAFAFA;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-card {
            background: white;
            padding: 48px;
            border-radius: 12px;
            border: 1px solid #E8E8E8;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            max-width: 400px;
            width: 90%;
        }

        .login-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1A1A1A;
            margin-bottom: 8px;
            text-align: center;
        }

        .login-subtitle {
            font-size: 0.9375rem;
            color: #666666;
            margin-bottom: 32px;
            text-align: center;
        }

        .user-option {
            padding: 14px 18px;
            border: 1px solid #E8E8E8;
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .user-option:hover {
            border-color: #1A1A1A;
            background: #F9FAFB;
        }

        .user-name {
            font-weight: 600;
            color: #1A1A1A;
        }

        .user-role {
            font-size: 0.875rem;
            color: #666666;
        }

        /* Calendar Styles */
        .calendar-container {
            background: white;
            border: 1px solid #E8E8E8;
            border-radius: 8px;
            padding: 24px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .calendar-month {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1A1A1A;
        }

        .calendar-nav {
            display: flex;
            gap: 8px;
        }

        .calendar-nav button {
            width: 36px;
            height: 36px;
            padding: 0;
            border-radius: 6px;
            font-size: 1.125rem;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .calendar-day-header {
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: #999999;
            padding: 8px 4px;
            text-transform: uppercase;
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 1px solid #E8E8E8;
            border-radius: 6px;
            padding: 8px;
            position: relative;
            cursor: pointer;
            transition: all 0.15s;
            min-height: 80px;
            max-height: 120px;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .calendar-day::-webkit-scrollbar {
            width: 4px;
        }
        
        .calendar-day::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .calendar-day::-webkit-scrollbar-thumb {
            background: #D1D5DB;
            border-radius: 2px;
        }
        
        .calendar-day::-webkit-scrollbar-thumb:hover {
            background: #9CA3AF;
        }

        .calendar-day:hover {
            border-color: #1A1A1A;
            background: #F9FAFB;
        }

        .calendar-day.empty {
            border: none;
            cursor: default;
        }

        .calendar-day.empty:hover {
            background: transparent;
        }

        .day-number {
            font-size: 0.875rem;
            font-weight: 600;
            color: #1A1A1A;
            margin-bottom: 4px;
            flex-shrink: 0;
        }

        .day-shift {
            font-size: 0.75rem;
            padding: 3px 6px;
            border-radius: 4px;
            margin-bottom: 2px;
            flex-shrink: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        .day-shift.current-user {
            background: #1A1A1A;
            color: white;
        }

        .day-shift.other-user {
            background: #F0F0F0;
            color: #666666;
        }

        /* Special shift states */
        .day-shift.seeking-coverage {
            background: #FED7AA !important;  /* Pastel orange - needs coverage */
            color: #9A3412 !important;
            font-weight: 600;
            border: 2px solid #FB923C;
        }

        .day-shift.offering-coverage {
            background: #BBF7D0 !important;  /* Pastel green - available to cover */
            color: #166534 !important;
            font-weight: 600;
            border: 2px solid #4ADE80;
        }

        .shift-tooltip {
            position: absolute;
            background: #1A1A1A;
            color: white;
            padding: 12px;
            border-radius: 6px;
            font-size: 0.8125rem;
            z-index: 1000;
            min-width: 200px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            pointer-events: none;
        }

        .shift-tooltip-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .shift-tooltip-detail {
            margin: 2px 0;
            color: #CCCCCC;
        }

        /* Chat Message Bubbles */
        .chat-messages {
            max-height: 450px;
            overflow-y: auto;
            padding: 16px;
            background: #FAFAFA;
            border-radius: 12px;
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            scroll-behavior: smooth;
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: #F3F4F6;
            border-radius: 3px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: #D1D5DB;
            border-radius: 3px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #9CA3AF;
        }

        #recentActivity::-webkit-scrollbar {
            width: 6px;
        }
        
        #recentActivity::-webkit-scrollbar-track {
            background: #F3F4F6;
            border-radius: 3px;
        }
        
        #recentActivity::-webkit-scrollbar-thumb {
            background: #D1D5DB;
            border-radius: 3px;
        }
        
        #recentActivity::-webkit-scrollbar-thumb:hover {
            background: #9CA3AF;
        }

        #dashboardCalendarGrid::-webkit-scrollbar,
        #allShiftsCalendarGrid::-webkit-scrollbar {
            width: 6px;
        }
        
        #dashboardCalendarGrid::-webkit-scrollbar-track,
        #allShiftsCalendarGrid::-webkit-scrollbar-track {
            background: #F3F4F6;
            border-radius: 3px;
        }
        
        #dashboardCalendarGrid::-webkit-scrollbar-thumb,
        #allShiftsCalendarGrid::-webkit-scrollbar-thumb {
            background: #D1D5DB;
            border-radius: 3px;
        }
        
        #dashboardCalendarGrid::-webkit-scrollbar-thumb:hover,
        #allShiftsCalendarGrid::-webkit-scrollbar-thumb:hover {
            background: #9CA3AF;
        }

        .chat-message-wrapper {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        .chat-message-wrapper.user {
            flex-direction: row-reverse;
        }

        .chat-bubble {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 0.9375rem;
            line-height: 1.5;
            word-wrap: break-word;
            min-height: 20px; /* Ensure bubbles have height */
            display: block; /* Ensure they're visible */
        }

        .chat-bubble.user {
            background: #1A1A1A;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-bubble.assistant {
            background: white;
            color: #1A1A1A;
            border: 1px solid #E5E7EB;
            border-bottom-left-radius: 4px;
        }

        .chat-bubble.system {
            background: #ECFDF5;
            border: 1px solid #10B981;
            border-left: 4px solid #10B981;
            color: #047857;
            max-width: 90%;
        }

        .chat-bubble.warning {
            background: #FEF3C7;
            border: 1px solid #F59E0B;
            border-left: 4px solid #F59E0B;
            color: #78350F;
            max-width: 90%;
        }

        .chat-bubble.error {
            background: #FEE2E2;
            border: 1px solid #DC2626;
            border-left: 4px solid #DC2626;
            color: #7F1D1D;
            max-width: 90%;
        }

        .chat-timestamp {
            font-size: 0.75rem;
            color: #9CA3AF;
            margin-top: 4px;
        }

        .chat-empty {
            text-align: center;
            color: #9CA3AF;
            padding: 48px 16px;
            font-size: 0.9375rem;
        }

        .match-card {
            background: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
        }

        .match-card.best {
            background: #ECFDF5;
            border-color: #10B981;
        }

        .match-name {
            font-weight: 600;
            color: #1A1A1A;
            margin-bottom: 4px;
        }

        .match-details {
            font-size: 0.8125rem;
            color: #666666;
            margin-bottom: 6px;
        }

        .match-reason {
            font-size: 0.8125rem;
            color: #374151;
            font-style: italic;
        }

        #thinking-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #thinking-indicator .loading {
            width: 16px;
            height: 16px;
            border-width: 2px;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            /* Stack all 2-column grids on smaller screens */
            #dashboard-section > div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
            
            /* Adjust chat height for stacked layout */
            .chat-messages {
                max-height: 400px !important;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }

            .main-content {
                margin-left: 0;
            }

            .container {
                padding: 20px 16px;
            }

            .main-grid {
                grid-template-columns: 1fr;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .calendar-day {
                min-height: 60px;
                padding: 4px;
            }

            .day-shift {
                font-size: 0.65rem;
                padding: 2px 4px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <div class="login-title">ShiftSwap AI</div>
            <div class="login-subtitle">Select your profile to continue</div>
            <div id="userOptions"></div>
        </div>
    </div>

    <!-- Left Sidebar -->
    <div class="sidebar" style="display: none;">
        <div class="sidebar-header">
            <div class="sidebar-brand">
                <div class="sidebar-brand-icon">SS</div>
                <span>ShiftSwap AI</span>
            </div>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-item active" onclick="navigateTo('dashboard')">
                <div class="nav-icon">â¦</div>
                <span>Dashboard</span>
            </div>
            <div class="nav-item" onclick="navigateTo('new-shift')">
                <div class="nav-icon">+</div>
                <span>New Shift</span>
            </div>
            <div class="nav-item" onclick="navigateTo('all-shifts')">
                <div class="nav-icon">â«</div>
                <span>All Shifts</span>
            </div>
            <div class="nav-item" onclick="navigateTo('ai-chat')">
                <div class="nav-icon">â¡</div>
                <span>AI Chat</span>
            </div>
            <div class="nav-item" onclick="navigateTo('analytics')">
                <div class="nav-icon">â</div>
                <span>Analytics</span>
            </div>
            <div class="nav-item" onclick="navigateTo('settings')">
                <div class="nav-icon">â</div>
                <span>Settings</span>
            </div>
        </nav>
        <div class="sidebar-footer">
            Powered by Cloudflare Workers AI
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="page-title-bar">Shift Management</div>
            <div class="top-bar-actions">
                <button style="width: auto; padding: 8px 16px;" onclick="navigateTo('new-shift')">New Shift</button>
            </div>
        </div>

        <div class="container">
            <!-- Dashboard Section -->
            <div id="dashboard-section" class="section">
                <div class="page-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div>
                            <h1 style="font-size: 1.875rem; font-weight: 700; margin: 0; color: #1F2937;">
                                Hi, <span id="dashboardUserName" style="color: #059669;">User</span>! ð
                            </h1>
                            <div class="page-subtitle" style="margin-top: 4px;">Manage your shifts and get AI-powered matching suggestions</div>
                        </div>
                    </div>
                </div>

                <!-- Calendar and Trends -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                    <!-- Calendar -->
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h2 style="margin: 0;">Calendar</h2>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button onclick="changeDashboardMonth(-1)" style="padding: 4px 12px; font-size: 0.875rem; min-width: auto;">â</button>
                                <span id="dashboardCalendarMonth" style="font-size: 0.875rem; font-weight: 600; min-width: 120px; text-align: center;"></span>
                                <button onclick="changeDashboardMonth(1)" style="padding: 4px 12px; font-size: 0.875rem; min-width: auto;">â¶</button>
                            </div>
                        </div>
                        
                        <!-- Calendar Legend -->
                        <div style="display: flex; gap: 12px; margin-bottom: 12px; font-size: 0.75rem; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <div style="width: 12px; height: 12px; background: #1A1A1A; border-radius: 2px;"></div>
                                <span>You</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <div style="width: 12px; height: 12px; background: #FED7AA; border: 2px solid #FB923C; border-radius: 2px;"></div>
                                <span>Needs Cover</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <div style="width: 12px; height: 12px; background: #BBF7D0; border: 2px solid #4ADE80; border-radius: 2px;"></div>
                                <span>Available</span>
                            </div>
                        </div>
                        
                        <div id="dashboardCalendarGrid" class="calendar-grid" style="height: 280px; overflow-y: auto;"></div>
                    </div>

                    <!-- Coverage Trends Graph -->
                    <div class="card">
                        <h2 style="margin-bottom: 16px;">Coverage Trends</h2>
                        <div style="display: flex; gap: 32px; margin-bottom: 20px;">
                            <div>
                                <div style="font-size: 0.75rem; color: #666666; margin-bottom: 4px;">â  Requests</div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: #DC2626;" id="graphRequests">0</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #666666; margin-bottom: 4px;">â  Covered</div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: #10B981;" id="graphCovered">0</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #666666; margin-bottom: 4px;">Coverage Rate</div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: #1A1A1A;" id="graphRate">0%</div>
                            </div>
                        </div>
                        <canvas id="coverageChart" width="600" height="180"></canvas>
                    </div>
                </div>

                <!-- AI Chat and Recent Activity -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                    <!-- AI Coverage Assistant -->
                    <div class="card">
                        <h2 style="margin-bottom: 8px;">AI Coverage Assistant</h2>
                        <p style="color: #666666; font-size: 0.875rem; margin-bottom: 16px;">
                            Tell me when you need coverage or when you're available.
                        </p>
                        
                        <!-- Chat Messages -->
                        <div class="chat-messages" id="dashboardChatMessages" style="max-height: 350px;">
                            <div class="chat-empty">Start a conversation by typing below...</div>
                        </div>
                        
                        <!-- Chat Input -->
                        <div style="position: relative;">
                            <input 
                                type="text" 
                                id="dashboardChatInput" 
                                placeholder="e.g., 'I need Friday 9am-5pm covered'"
                                style="width: 100%; padding: 14px 110px 14px 16px; border: 2px solid #E5E7EB; border-radius: 12px; font-size: 0.9375rem; transition: border-color 0.2s;"
                                onkeypress="if(event.key==='Enter') sendDashboardChat()"
                                onfocus="this.style.borderColor='#1A1A1A'"
                                onblur="this.style.borderColor='#E5E7EB'"
                            >
                            <div style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); display: flex; gap: 8px;">
                                <button onclick="startVoiceInputDashboard()" id="voiceBtnDashboard" class="btn-secondary" style="padding: 6px 12px; font-size: 0.8125rem; min-width: auto;">
                                    â
                                </button>
                                <button onclick="sendDashboardChat()" style="padding: 6px 16px; font-size: 0.8125rem; min-width: auto;">
                                    Send
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="card">
                        <h2 style="margin-bottom: 16px;">Recent Activity</h2>
                        <div id="recentActivity" style="max-height: 445px; overflow-y: auto;">
                            <div class="empty-state">
                                <div class="empty-state-icon">â</div>
                                <p>No recent activity yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Dashboard Section -->

            <!-- New Shift Section -->
            <div id="new-shift-section" class="section" style="display: none;">
                <div class="page-header">
                    <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 8px;">Post New Shift</h2>
                    <div class="page-subtitle">Create a new shift request for coverage</div>
                </div>
                <div class="card">
                    <form id="postFormAlt">
                        <div class="form-group">
                            <label for="userRoleAlt">Your Role *</label>
                            <input type="text" id="userRoleAlt" required placeholder="e.g., Nurse, Doctor, Instructor">
                        </div>
                        <div class="form-group">
                            <label for="shiftDateAlt">Shift Date *</label>
                            <input type="date" id="shiftDateAlt" required>
                        </div>
                        <div class="form-group">
                            <label for="shiftTimeAlt">Shift Time *</label>
                            <input type="text" id="shiftTimeAlt" required placeholder="e.g., 09:00-17:00">
                        </div>
                        <div class="form-group">
                            <label for="shiftNotesAlt">Notes (Optional)</label>
                            <textarea id="shiftNotesAlt" placeholder="Any additional information..."></textarea>
                        </div>
                        <button type="submit">Post Shift</button>
                    </form>
                    <div id="postMessageAlt"></div>
                </div>
            </div>
            <!-- End New Shift Section -->

            <!-- All Shifts Section -->
            <div id="all-shifts-section" class="section" style="display: none;">
                <div class="page-header">
                    <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 8px;">Shift Calendar</h2>
                    <div class="page-subtitle">View all scheduled shifts across the month</div>
                </div>
                <div class="calendar-container">
                    <div class="calendar-header">
                        <div class="calendar-month" id="allShiftsCalendarMonth"></div>
                        <div class="calendar-nav">
                            <button onclick="changeAllShiftsMonth(-1)" class="btn-secondary">â</button>
                            <button onclick="changeAllShiftsMonth(1)" class="btn-secondary">â</button>
                        </div>
                    </div>
                    <div class="calendar-grid" id="allShiftsCalendarGrid"></div>
                </div>
                <div id="shiftTooltip" class="shift-tooltip" style="display: none;"></div>
            </div>
            <!-- End All Shifts Section -->

            <!-- AI Chat Section -->
            <div id="ai-chat-section" class="section" style="display: none;">
                <div class="page-header">
                    <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 8px;">AI Chat Assistant</h2>
                    <div class="page-subtitle">Post shifts using natural language or voice input</div>
                </div>
                <div class="card">
                    <div class="info-box">
                        <div class="info-box-title">Natural Language Input</div>
                        <p>Describe your shift in plain English. Try: "I need coverage for Friday 9am-5pm, I'm a nurse"</p>
                    </div>
                    <div id="chatContainerAlt" style="margin-bottom: 16px; max-height: 400px; overflow-y: auto; padding: 12px; background: #F9FAFB; border-radius: 6px; border: 1px solid #E5E7EB;">
                        <div class="chat-message assistant">
                            <strong>AI Assistant:</strong> Hi! Tell me about the shift you need covered. You can type or use voice input.
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="chatInputAlt" placeholder="Type your message..." style="flex: 1;" onkeypress="if(event.key==='Enter') sendChatMessage()">
                        <button onclick="sendChatMessage()" style="width: auto; padding: 10px 20px;">Send</button>
                        <button onclick="startVoiceInput()" id="voiceBtnAlt" class="btn-secondary" style="width: auto; padding: 10px 20px;">â Voice</button>
                    </div>
                </div>
            </div>
            <!-- End AI Chat Section -->

            <!-- Analytics Section -->
            <div id="analytics-section" class="section" style="display: none;">
                <div class="page-header">
                    <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 8px;">Analytics</h2>
                    <div class="page-subtitle">View insights and statistics about your shifts</div>
                </div>
                <div class="card">
                    <h3 style="margin-bottom: 16px;">Overview</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div class="stat-card">
                            <div class="stat-label">Total Shifts</div>
                            <div class="stat-value" id="statTotalAnalytics">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Open Shifts</div>
                            <div class="stat-value" id="statOpenAnalytics">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">AI Matches</div>
                            <div class="stat-value" id="statMatchesAnalytics">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Most Requested</div>
                            <div class="stat-value" id="statTopRoleAnalytics" style="font-size: 0.875rem;">-</div>
                        </div>
                    </div>
                    <div style="padding: 24px; background: #F9FAFB; border-radius: 8px; border: 1px solid #E8E8E8;">
                        <p style="color: #666666; text-align: center;">More analytics features coming soon...</p>
                    </div>
                </div>
            </div>
            <!-- End Analytics Section -->

            <!-- Settings Section -->
            <div id="settings-section" class="section" style="display: none;">
                <div class="page-header">
                    <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 8px;">Settings</h2>
                    <div class="page-subtitle">Configure your ShiftSwap AI preferences</div>
                </div>
                <div class="card">
                    <h3 style="margin-bottom: 16px;">User Profile</h3>
                    <div style="padding: 20px; background: #F9FAFB; border-radius: 8px; border: 1px solid #E8E8E8; margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px;">
                            <div style="width: 48px; height: 48px; background: #1A1A1A; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.125rem;" id="userAvatar">A</div>
                            <div>
                                <div style="font-weight: 600; font-size: 1rem; color: #1A1A1A;" id="currentUserName">Loading...</div>
                                <div style="font-size: 0.875rem; color: #666666;" id="currentUserRole">Loading...</div>
                            </div>
                        </div>
                        <button onclick="logout()" class="btn-secondary" style="width: 100%; margin-top: 12px; background: #DC2626; color: white; border: none;">
                            Switch User
                        </button>
                    </div>
                    
                    <h3 style="margin-bottom: 16px;">Application Settings</h3>
                    <div class="form-group">
                        <label>AI Model</label>
                        <select style="width: 100%;" disabled>
                            <option>Llama 3.3 70B (Workers AI)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notifications</label>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="notificationsEnabled">
                            <label for="notificationsEnabled" style="margin: 0; font-weight: normal;">Enable notifications</label>
                        </div>
                    </div>
                    
                    <h3 style="margin-bottom: 16px; margin-top: 32px;">Data Management</h3>
                    <div style="padding: 20px; background: #F0FDF4; border-radius: 8px; border: 1px solid #86EFAC; margin-bottom: 16px;">
                        <div style="font-size: 0.875rem; color: #1F2937; margin-bottom: 12px;">
                            <strong>ð Note:</strong> This will clear all current coverage requests and availability offers, then reload the default demo shifts into the calendar.
                        </div>
                        <button onclick="resetCalendar()" class="btn-secondary" style="width: 100%; background: #059669; color: white; border: none;">
                            Reset Calendar & Coverage Requests
                        </button>
                        <div id="resetMessage" style="margin-top: 12px;"></div>
                    </div>
                </div>
            </div>
            <!-- End Settings Section -->

        <footer style="margin-top: 48px; padding: 24px 0; text-align: center; font-size: 0.8125rem; color: #999999; border-top: 1px solid #E8E8E8;">
            <p>Built with Cloudflare Workers, Durable Objects, and Workers AI</p>
            <p>Â© 2025 ShiftSwap AI</p>
        </footer>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = window.location.origin;
        let chatHistory = [];
        let isRecording = false;
        let currentUser = null;
        let dashboardMonth = new Date();  // Separate calendar for dashboard
        let allShiftsMonth = new Date();  // Separate calendar for All Shifts page
        
        // Debug: Log the initial dates
        console.log('[Init] Dashboard month:', dashboardMonth.toLocaleDateString());
        console.log('[Init] All shifts month:', allShiftsMonth.toLocaleDateString());

        // Mock Users
        const MOCK_USERS = [
            { name: 'Alice Johnson', role: 'Nurse' },
            { name: 'Bob Smith', role: 'Doctor' },
            { name: 'Carol Williams', role: 'Instructor' },
            { name: 'David Brown', role: 'Nurse' },
            { name: 'Emma Davis', role: 'Receptionist' },
            { name: 'Frank Miller', role: 'Doctor' }
        ];

        // Mock Shifts Data - Generate shifts across multiple months
        const MOCK_SHIFTS = generateMockShifts();

        function generateMockShifts() {
            const shifts = [];
            const startDate = new Date(2025, 0, 1); // Jan 1, 2025
            const endDate = new Date(2025, 11, 31); // Dec 31, 2025
            
            const shiftTypes = ['Morning', 'Afternoon', 'Evening', 'Night'];
            const times = ['08:00-16:00', '14:00-22:00', '16:00-00:00', '00:00-08:00'];
            
            // Generate shifts for each user
            MOCK_USERS.forEach((user, userIndex) => {
                // Each user gets 2-3 shifts per month
                for (let month = 0; month < 12; month++) {
                    const shiftsThisMonth = 2 + Math.floor(Math.random() * 2);
                    for (let i = 0; i < shiftsThisMonth; i++) {
                        const day = Math.floor(Math.random() * 28) + 1;
                        const shiftIndex = Math.floor(Math.random() * shiftTypes.length);
                        const date = new Date(2025, month, day);
                        
                        shifts.push({
                            id: `mock-${userIndex}-${month}-${i}`,
                            user: user.name,
                            role: user.role,
                            date: date.toISOString().split('T')[0],
                            shift: `${shiftTypes[shiftIndex]} (${times[shiftIndex]})`,
                            notes: Math.random() > 0.7 ? 'Can swap if needed' : '',
                            createdAt: new Date().toISOString()
                        });
                    }
                }
            });
            
            return shifts;
        }

        // ======================================================================
        // LOGIN SYSTEM
        // ======================================================================

        function initializeLogin() {
            const userOptions = document.getElementById('userOptions');
            
            MOCK_USERS.forEach(user => {
                const option = document.createElement('div');
                option.className = 'user-option';
                option.innerHTML = `
                    <div>
                        <div class="user-name">${user.name}</div>
                        <div class="user-role">${user.role}</div>
                    </div>
                    <span>â</span>
                `;
                option.onclick = () => selectUser(user);
                userOptions.appendChild(option);
            });
        }

        function selectUser(user) {
            currentUser = user;
            localStorage.setItem('currentUser', JSON.stringify(user));
            console.log('[Login] User selected:', user.name);
            
            // Hide login screen
            document.getElementById('loginScreen').style.display = 'none';
            
            // Show main app
            document.querySelector('.sidebar').style.display = 'flex';
            document.querySelector('.main-content').style.display = 'block';
            
            // Make sure dashboard section is visible
            const dashboardSection = document.getElementById('dashboard-section');
            if (dashboardSection) {
                dashboardSection.style.display = 'block';
                console.log('[Login] Dashboard section set to visible');
            }
            
            // Initialize the app with a small delay to ensure DOM is ready
            setTimeout(() => {
                console.log('[Login] Initializing app for user:', currentUser.name);
                console.log('[Login] Dashboard month:', dashboardMonth.toLocaleString());
                // Don't call refreshShifts() or setDefaultDate() - those are for New Shift page
                updateUserProfile();  // Update the greeting and user info
                updateAnalytics();
                renderCalendar('dashboard');  // Start with dashboard calendar only
            }, 150);
        }

        function checkLogin() {
            const savedUser = localStorage.getItem('currentUser');
            console.log('[Login] Checking login, saved user:', savedUser);
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                console.log('[Login] User found:', currentUser.name);
                document.getElementById('loginScreen').style.display = 'none';
                document.querySelector('.sidebar').style.display = 'flex';
                document.querySelector('.main-content').style.display = 'block';
                return true;
            }
            console.log('[Login] No user found, showing login screen');
            document.getElementById('loginScreen').style.display = 'flex';
            document.querySelector('.sidebar').style.display = 'none';
            document.querySelector('.main-content').style.display = 'none';
            return false;
        }

        function logout() {
            localStorage.removeItem('currentUser');
            location.reload();
        }

        async function resetCalendar() {
            const confirmed = confirm('Reset calendar to default demo shifts? This will clear all current coverage requests and availability offers.');
            if (!confirmed) return;

            const messageEl = document.getElementById('resetMessage');
            messageEl.innerHTML = '<span style="color: #666666;">ð Resetting calendar...</span>';

            try {
                // Step 1: Clear all existing data
                console.log('[Reset] Step 1: Clearing existing data...');
                const clearResponse = await fetch(`${API_BASE}/api/clear`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!clearResponse.ok) {
                    throw new Error('Failed to clear existing data');
                }

                messageEl.innerHTML = '<span style="color: #666666;">ð Loading demo shifts...</span>';

                // Step 2: Load default demo shifts
                console.log('[Reset] Step 2: Loading demo shifts...');
                // Demo shifts - max 2 per day to prevent overflow
                const demoShifts = [
                    {
                        user: "Alice Johnson",
                        role: "Nurse",
                        date: "2025-10-15",
                        shift: "09:00-17:00",
                        notes: "Preferably swap with another RN"
                    },
                    {
                        user: "Dr. Charlie Brown",
                        role: "Doctor",
                        date: "2025-10-15",
                        shift: "14:00-22:00",
                        notes: "Evening shift preferred"
                    },
                    {
                        user: "Bob Smith",
                        role: "Nurse",
                        date: "2025-10-18",
                        shift: "09:00-17:00",
                        notes: "Flexible with dates"
                    },
                    {
                        user: "Diana Prince",
                        role: "Nurse",
                        date: "2025-10-22",
                        shift: "21:00-05:00",
                        notes: "Night shift, prefer someone experienced with ICU"
                    }
                ];

                // Post each demo shift
                let successCount = 0;
                for (const shift of demoShifts) {
                    try {
                        const postResponse = await fetch(`${API_BASE}/api/post`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(shift)
                        });
                        
                        if (postResponse.ok) {
                            successCount++;
                            console.log('[Reset] Posted shift for:', shift.user);
                        }
                    } catch (err) {
                        console.error('[Reset] Failed to post shift for:', shift.user, err);
                    }
                }

                console.log('[Reset] Successfully posted', successCount, 'of', demoShifts.length, 'demo shifts');
                messageEl.innerHTML = '<span style="color: #059669; font-weight: 600;">â Calendar reset successfully! Loaded ' + successCount + ' demo shifts.</span>';
                
                // Step 3: Refresh all displays
                console.log('[Reset] Step 3: Refreshing UI...');
                setTimeout(async () => {
                    await refreshAllData();
                    messageEl.innerHTML = '';
                    console.log('[Reset] â Reset complete!');
                }, 2000);

            } catch (error) {
                console.error('[Reset] Error:', error);
                messageEl.innerHTML = '<span style="color: #DC2626;">â Error: ' + error.message + '</span>';
            }
        }

        function updateUserProfile() {
            if (currentUser) {
                const avatar = document.getElementById('userAvatar');
                const userName = document.getElementById('currentUserName');
                const userRole = document.getElementById('currentUserRole');
                const dashboardUserName = document.getElementById('dashboardUserName');
                
                if (avatar) avatar.textContent = currentUser.name.charAt(0).toUpperCase();
                if (userName) userName.textContent = currentUser.name;
                if (userRole) userRole.textContent = currentUser.role;
                if (dashboardUserName) dashboardUserName.textContent = currentUser.name;
            }
        }

        // ======================================================================
        // CALENDAR SYSTEM
        // ======================================================================

        async function renderCalendar(calendarType = 'both') {
            console.log('[renderCalendar] Called with type:', calendarType, 'currentUser:', currentUser?.name);
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            
            // Render dashboard calendar
            if (calendarType === 'dashboard' || calendarType === 'both') {
                const calendarGrid = document.getElementById('dashboardCalendarGrid');
                const calendarMonth = document.getElementById('dashboardCalendarMonth');
                
                console.log('[renderCalendar] Dashboard elements:', {
                    gridExists: !!calendarGrid,
                    monthExists: !!calendarMonth,
                    dashboardMonth: dashboardMonth
                });
                
                if (calendarGrid && calendarMonth) {
                    const year = dashboardMonth.getFullYear();
                    const month = dashboardMonth.getMonth();
                    console.log('[Calendar] Rendering dashboard:', monthNames[month], year);
                    calendarMonth.textContent = `${monthNames[month]} ${year}`;
                    
                    try {
                        await renderCalendarGrid(calendarGrid, dashboardMonth);
                        console.log('[Calendar] Dashboard calendar rendered successfully');
                    } catch (error) {
                        console.error('[Calendar] Error rendering dashboard calendar:', error);
                        calendarGrid.innerHTML = '<div style="padding: 20px; color: red;">Error: ' + error.message + '</div>';
                    }
                } else {
                    console.error('[Calendar] Dashboard calendar elements not found!');
                }
            }
            
            // Render all shifts calendar
            if (calendarType === 'allShifts' || calendarType === 'both') {
                const calendarGrid = document.getElementById('allShiftsCalendarGrid');
                const calendarMonth = document.getElementById('allShiftsCalendarMonth');
                
                if (calendarGrid && calendarMonth) {
                    const year = allShiftsMonth.getFullYear();
                    const month = allShiftsMonth.getMonth();
                    calendarMonth.textContent = `${monthNames[month]} ${year}`;
                    await renderCalendarGrid(calendarGrid, allShiftsMonth);
                }
            }
        }

        async function renderCalendarGrid(calendarGrid, currentMonth) {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            // CRITICAL: Check if currentUser is set
            if (!currentUser) {
                console.error('[Calendar] Cannot render calendar - currentUser is null');
                calendarGrid.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Please log in to view calendar</div>';
                return;
            }
            
            console.log('[Calendar] Rendering grid for:', year, month, 'User:', currentUser.name);
            
            // Fetch real shifts from API
            let realShifts = [];
            try {
                const response = await fetch(`${API_BASE}/api/list`);
                if (response.ok) {
                    realShifts = await response.json();
                }
            } catch (error) {
                console.error('Failed to fetch shifts:', error);
            }
            
            // Merge mock shifts with real shifts (real shifts override mock)
            const allShifts = [...MOCK_SHIFTS];
            realShifts.forEach(realShift => {
                // Add real shift (it will show as real data)
                allShifts.push({
                    ...realShift,
                    isReal: true  // Mark as real shift from API
                });
            });
            
            // Clear grid
            calendarGrid.innerHTML = '';
            
            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                calendarGrid.appendChild(header);
            });
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Add empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                calendarGrid.appendChild(emptyDay);
            }
            
            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayCell.appendChild(dayNumber);
                
                // Get shifts for this day
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayShifts = allShifts.filter(shift => shift.date === dateStr);
                
                // Add shift indicators
                dayShifts.forEach(shift => {
                    const shiftEl = document.createElement('div');
                    
                    // Determine shift class based on type
                    let shiftClass = 'day-shift ';
                    if (shift.user === currentUser.name) {
                        shiftClass += 'current-user';
                    } else {
                        shiftClass += 'other-user';
                    }
                    
                    // Add special styling for real shifts - flexible matching
                    if (shift.isReal && shift.notes) {
                        const notes = shift.notes.toLowerCase();
                        if (notes.includes('seeking') || notes.includes('need') || notes.includes('cover me') || notes.includes('request')) {
                            shiftClass += ' seeking-coverage';  // Needs coverage
                        } else if (notes.includes('available') || notes.includes('can cover') || notes.includes('offering')) {
                            shiftClass += ' offering-coverage';  // Offering to cover
                        }
                    }
                    
                    shiftEl.className = shiftClass;
                    shiftEl.textContent = shift.user.split(' ')[0]; // First name only
                    shiftEl.dataset.shift = JSON.stringify(shift);
                    
                    // Add hover events for tooltip
                    shiftEl.addEventListener('mouseenter', (e) => showTooltip(e, shift));
                    shiftEl.addEventListener('mouseleave', hideTooltip);
                    
                    dayCell.appendChild(shiftEl);
                });
                
                calendarGrid.appendChild(dayCell);
            }
        }

        function changeDashboardMonth(delta) {
            dashboardMonth.setMonth(dashboardMonth.getMonth() + delta);
            renderCalendar('dashboard');
        }

        function changeAllShiftsMonth(delta) {
            allShiftsMonth.setMonth(allShiftsMonth.getMonth() + delta);
            renderCalendar('allShifts');
        }

        function showTooltip(event, shift) {
            const tooltip = document.getElementById('shiftTooltip');
            tooltip.innerHTML = `
                <div class="shift-tooltip-title">${shift.user}</div>
                <div class="shift-tooltip-detail">Role: ${shift.role}</div>
                <div class="shift-tooltip-detail">Date: ${shift.date}</div>
                <div class="shift-tooltip-detail">Time: ${shift.shift}</div>
                ${shift.notes ? `<div class="shift-tooltip-detail">Notes: ${shift.notes}</div>` : ''}
            `;
            
            const rect = event.target.getBoundingClientRect();
            tooltip.style.display = 'block';
            tooltip.style.left = rect.left + 'px';
            tooltip.style.top = (rect.bottom + 5) + 'px';
        }

        function hideTooltip() {
            const tooltip = document.getElementById('shiftTooltip');
            tooltip.style.display = 'none';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[Init] DOM Content Loaded');
            initializeLogin();
            if (checkLogin()) {
                // Ensure dashboard section is visible
                const dashboardSection = document.getElementById('dashboard-section');
                if (dashboardSection) {
                    dashboardSection.style.display = 'block';
                    console.log('[Init] Dashboard section made visible');
                }
                
                // Add a small delay to ensure currentUser is fully set and DOM is ready
                setTimeout(() => {
                    console.log('[Init] Starting app initialization for:', currentUser?.name);
                    console.log('[Init] Dashboard month before render:', dashboardMonth.toLocaleString());
                    // Don't call refreshShifts() or setDefaultDate() on dashboard - those are for New Shift page
                    updateUserProfile();  // Update the greeting and user info
                    updateAnalytics();
                    renderCalendar('dashboard');  // Only render dashboard calendar on initial load
                }, 150);
            }
        });

        // ======================================================================
        // NAVIGATION
        // ======================================================================

        function navigateTo(sectionName, event) {
            // Hide all sections
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => {
                section.style.display = 'none';
            });

            // Show the selected section
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.style.display = 'block';
            }

            // Update active state on nav items
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and activate the clicked nav item
            const clickedItem = Array.from(navItems).find(item => 
                item.textContent.toLowerCase().includes(sectionName.replace(/-/g, ' '))
            );
            if (clickedItem) {
                clickedItem.classList.add('active');
            }

            // Update top bar title
            const pageTitles = {
                'dashboard': 'Shift Management',
                'new-shift': 'Post New Shift',
                'all-shifts': 'All Shifts',
                'ai-chat': 'AI Chat Assistant',
                'analytics': 'Analytics',
                'settings': 'Settings'
            };
            document.querySelector('.page-title-bar').textContent = pageTitles[sectionName] || 'Dashboard';

            // Load data for specific sections
            if (sectionName === 'new-shift') {
                setDefaultDate();  // Set default date for the form
                refreshShifts();   // Load shifts list for this page
            }
            if (sectionName === 'all-shifts') {
                renderCalendar('allShifts');
            }
            if (sectionName === 'analytics') {
                updateAnalyticsAlt();
            }
            if (sectionName === 'settings') {
                updateUserProfile();
            }
        }

        // ======================================================================
        // ANALYTICS DASHBOARD
        // ======================================================================

        async function updateAnalytics() {
            try {
                const response = await fetch(`${API_BASE}/api/list`);
                const shifts = await response.json();
                
                // These elements don't exist on dashboard anymore (replaced with calendar)
                // Just skip them if not found
                const statTotal = document.getElementById('statTotal');
                if (statTotal) statTotal.textContent = shifts.length;
                
                const statOpen = document.getElementById('statOpen');
                if (statOpen) statOpen.textContent = shifts.length;
                
                const matchesCount = Math.floor(shifts.length * 0.7);
                const statMatches = document.getElementById('statMatches');
                if (statMatches) statMatches.textContent = matchesCount;
                
                const roleCounts = {};
                shifts.forEach(shift => {
                    roleCounts[shift.role] = (roleCounts[shift.role] || 0) + 1;
                });
                const topRole = Object.keys(roleCounts).reduce((a, b) => 
                    roleCounts[a] > roleCounts[b] ? a : b, '-'
                );
                const statTopRole = document.getElementById('statTopRole');
                if (statTopRole) statTopRole.textContent = topRole;
            } catch (error) {
                console.error('Analytics update failed:', error);
            }
            
            // Update graph and recent activity
            updateDashboardGraph();
            updateRecentActivity();
        }

        // ======================================================================
        // GLOBAL REFRESH FUNCTION
        // ======================================================================

        async function refreshAllData() {
            console.log('[Refresh] Updating all dashboard data...');
            try {
                // Refresh shifts list
                await refreshShifts();
                
                // Refresh analytics
                await updateAnalytics();
                
                // Refresh recent activity
                await updateRecentActivity();
                
                // Refresh dashboard graph
                await updateDashboardGraph();
                
                // Refresh both calendars
                await renderCalendar('both');
                
                console.log('[Refresh] All data updated successfully');
            } catch (error) {
                console.error('[Refresh] Error updating data:', error);
            }
        }

        // ======================================================================
        // DASHBOARD AI CHAT
        // ======================================================================

        // Store conversation context for multi-turn conversations
        let conversationContext = {
            lastIntent: null,
            partialData: {},
            messages: []
        };

        function addChatMessage(message, type = 'user', data = null) {
            console.log('[Chat] addChatMessage called:', { message, type, data });
            const messagesContainer = document.getElementById('dashboardChatMessages');
            
            if (!messagesContainer) {
                console.error('[Chat] dashboardChatMessages container not found!');
                return;
            }
            
            console.log('[Chat] Container found, current children:', messagesContainer.children.length);
            console.log('[Chat] Container visible?', messagesContainer.offsetParent !== null);
            console.log('[Chat] Container display:', window.getComputedStyle(messagesContainer).display);
            
            // Remove empty state if it exists
            const emptyState = messagesContainer.querySelector('.chat-empty');
            if (emptyState) {
                emptyState.remove();
                console.log('[Chat] Removed empty state');
            }

            const messageWrapper = document.createElement('div');
            messageWrapper.className = `chat-message-wrapper ${type}`;
            messageWrapper.style.marginBottom = '12px'; // Ensure spacing

            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${type}`;

            if (type === 'user') {
                bubble.textContent = message;
                console.log('[Chat] â Branch: USER MESSAGE');
                console.log('[Chat] Message text:', message);
            } else if (data) {
                console.log('[Chat] â Branch: ASSISTANT WITH DATA');
                console.log('[Chat] Checking data branches...');
                
                // Assistant response with structured data
                if (data.needsMoreInfo) {
                    console.log('[Chat] --> Taking needsMoreInfo branch');
                    bubble.className = 'chat-bubble assistant';
                    bubble.innerHTML = `<div>${data.message}</div>`;
                } else if (data.action === 'created') {
                    console.log('[Chat] --> Taking action=created branch');
                    console.log('[Chat] Has matches?', data.matches ? data.matches.length : 0);
                    bubble.className = 'chat-bubble system';
                    let content = `
                        <div style="font-weight: 600; margin-bottom: 6px;">â Availability Recorded!</div>
                        <div style="margin-bottom: 8px;">${data.message}</div>
                        ${data.shift ? `<div style="font-size: 0.875rem; color: #047857; margin-bottom: 12px;">ð ${data.shift.date} | â° ${data.shift.shift}</div>` : ''}
                    `;
                    
                    // If there are matching coverage requests, show them!
                    if (data.matches && data.matches.length > 0) {
                        console.log('[Chat] Found matching coverage requests:', data.matches.length);
                        content += `
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #10B981;">
                                <div style="font-weight: 600; margin-bottom: 8px;">${data.summary || 'People who need coverage:'}</div>
                        `;
                        data.matches.forEach((match, index) => {
                            content += `
                                <div class="match-card ${index === 0 ? 'best' : ''}" style="margin-top: 8px;">
                                    <div class="match-name">${index === 0 ? 'â­ ' : ''}${match.user} - ${match.role}</div>
                                    <div class="match-details">ð ${match.date} | â° ${match.shift}</div>
                                    <div class="match-reason">${match.reason}</div>
                                </div>
                            `;
                        });
                        content += `
                                <div style="margin-top: 10px; font-size: 0.9rem; color: #059669;">
                                    ${data.suggestion || ''}
                                </div>
                            </div>
                        `;
                    }
                    
                    bubble.innerHTML = content;
                    console.log('[Chat] Created message HTML length:', content.length);
                } else if (data.action === 'posted') {
                    console.log('[Chat] --> Taking action=posted branch');
                    console.log('[Chat] Has matches?', data.matches ? data.matches.length : 0);
                    bubble.className = 'chat-bubble system';
                    let content = `
                        <div style="font-weight: 600; margin-bottom: 6px;">ð¢ Coverage Request Posted!</div>
                        <div style="margin-bottom: 8px;">${data.message}</div>
                        ${data.shift ? `<div style="font-size: 0.875rem; color: #047857; margin-bottom: 12px;">ð ${data.shift.date} | â° ${data.shift.shift}</div>` : ''}
                    `;
                    
                    // If there are matches, show them too
                    if (data.matches && data.matches.length > 0) {
                        console.log('[Chat] Adding matches to posted message:', data.matches.length);
                        content += `
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #10B981;">
                                <div style="font-weight: 600; margin-bottom: 8px;">${data.summary || 'Available people:'}</div>
                        `;
                        data.matches.forEach((match, index) => {
                            content += `
                                <div class="match-card ${index === 0 ? 'best' : ''}" style="margin-top: 8px;">
                                    <div class="match-name">${index === 0 ? 'â­ ' : ''}${match.user} - ${match.role}</div>
                                    <div class="match-details">ð ${match.date} | â° ${match.shift}</div>
                                    <div class="match-reason">${match.reason}</div>
                                </div>
                            `;
                        });
                        content += `</div>`;
                    }
                    
                    bubble.innerHTML = content;
                    console.log('[Chat] Posted message HTML length:', content.length);
                } else if (data.matches && data.matches.length > 0) {
                    console.log('[Chat] --> Taking standalone matches branch');
                    console.log('[Chat] Matches count:', data.matches.length);
                    bubble.className = 'chat-bubble assistant';
                    let matchesHTML = `<div style="font-weight: 600; margin-bottom: 8px;">${data.summary || 'Found matches:'}</div>`;
                    data.matches.forEach((match, index) => {
                        matchesHTML += `
                            <div class="match-card ${index === 0 ? 'best' : ''}">
                                <div class="match-name">${index === 0 ? 'â­ ' : ''}${match.user} - ${match.role}</div>
                                <div class="match-details">ð ${match.date} | â° ${match.shift}</div>
                                <div class="match-reason">${match.reason}</div>
                            </div>
                        `;
                    });
                    bubble.innerHTML = matchesHTML;
                    console.log('[Chat] Matches HTML length:', matchesHTML.length);
                } else {
                    console.log('[Chat] --> Taking fallback/generic branch');
                    console.log('[Chat] data.message:', data.message);
                    console.log('[Chat] data.suggestion:', data.suggestion);
                    bubble.className = 'chat-bubble assistant';
                    let content = data.message || message;
                    // Check if this is a "Cover request sent" scenario
                    if (data.message && data.message.includes('posted')) {
                        console.log('[Chat] Message includes "posted", formatting specially');
                        content = `<div style="font-weight: 600; margin-bottom: 6px;">ð¢ Cover Request Sent!</div><div>${data.message}</div>`;
                    }
                    bubble.innerHTML = `
                        <div>${content}</div>
                        ${data.suggestion ? `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #E5E7EB; font-size: 0.875rem; color: #666;">ð¡ ${data.suggestion}</div>` : ''}
                    `;
                    console.log('[Chat] Generic message HTML length:', bubble.innerHTML.length);
                }
            } else {
                console.log('[Chat] â Branch: ASSISTANT WITHOUT DATA (plain text)');
                bubble.textContent = message;
            }

            messageWrapper.appendChild(bubble);
            messagesContainer.appendChild(messageWrapper);
            console.log('[Chat] Message added to DOM');
            console.log('[Chat] Total messages now:', messagesContainer.children.length);
            console.log('[Chat] Message wrapper HTML:', messageWrapper.outerHTML.substring(0, 200));
            console.log('[Chat] Bubble class:', bubble.className);
            console.log('[Chat] Bubble content length:', bubble.innerHTML.length);
            
            // Force reflow to ensure DOM update
            messagesContainer.offsetHeight;
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            console.log('[Chat] Scrolled to bottom, scrollTop:', messagesContainer.scrollTop);
        }

        async function sendDashboardChat() {
            console.log('[sendDashboardChat] ===== FUNCTION CALLED =====');
            
            // Check if dashboard is visible
            const dashboardSection = document.getElementById('dashboard-section');
            console.log('[sendDashboardChat] Dashboard section exists?', !!dashboardSection);
            if (dashboardSection) {
                console.log('[sendDashboardChat] Dashboard display:', dashboardSection.style.display);
                console.log('[sendDashboardChat] Dashboard visible?', dashboardSection.offsetParent !== null);
            }
            
            const input = document.getElementById('dashboardChatInput');
            const message = input.value.trim();
            console.log('[sendDashboardChat] Message:', message);
            console.log('[sendDashboardChat] Current user:', currentUser ? currentUser.name : 'NONE');
            
            if (!message) {
                console.log('[sendDashboardChat] Empty message, returning');
                return;
            }

            // Add user message to chat and conversation history
            console.log('[sendDashboardChat] Adding user message to chat');
            addChatMessage(message, 'user');
            conversationContext.messages.push({ role: 'user', content: message });
            
            // Clear input and disable
            const originalMessage = message;
            input.value = '';
            input.disabled = true;

            // Get current user's calendar shifts for context
            const userShifts = MOCK_SHIFTS.filter(s => s.user === currentUser.name);
            const shiftContext = userShifts.map(s => `${s.date}: ${s.shift} (${s.role})`).join('; ');

            // Add "thinking" indicator
            const messagesContainer = document.getElementById('dashboardChatMessages');
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'chat-message-wrapper assistant';
            thinkingDiv.innerHTML = `
                <div class="chat-bubble assistant" id="thinking-indicator">
                    <div class="loading"></div>
                    <span style="font-size: 0.875rem; color: #666;">AI is thinking...</span>
                </div>
            `;
            messagesContainer.appendChild(thinkingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            try {
                // Call intelligent matching API with timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout

                console.log('[sendDashboardChat] Sending request to /api/intelligent-match');
                console.log('[sendDashboardChat] Request body:', {
                    message: message,
                    currentUser: currentUser.name,
                    currentRole: currentUser.role,
                    userSchedule: shiftContext
                });
                
                const response = await fetch(`${API_BASE}/api/intelligent-match`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        currentUser: currentUser.name,
                        currentRole: currentUser.role,
                        userSchedule: shiftContext  // Pass calendar context
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                console.log('[sendDashboardChat] Response status:', response.status);
                console.log('[sendDashboardChat] Response ok?', response.ok);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[sendDashboardChat] Error response body:', errorText);
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('[sendDashboardChat] ===== API RESPONSE RECEIVED =====');
                console.log('[sendDashboardChat] Full result:', JSON.stringify(result, null, 2));
                console.log('[sendDashboardChat] Result keys:', Object.keys(result));
                console.log('[sendDashboardChat] Result.action:', result.action);
                console.log('[sendDashboardChat] Result.message:', result.message);
                console.log('[sendDashboardChat] Result.summary:', result.summary);
                console.log('[sendDashboardChat] Result.matches:', result.matches);
                console.log('[sendDashboardChat] Result.needsMoreInfo:', result.needsMoreInfo);

                // Remove thinking indicator
                const thinkingIndicator = document.getElementById('thinking-indicator');
                if (thinkingIndicator) {
                    console.log('[sendDashboardChat] Removing thinking indicator');
                    thinkingIndicator.parentElement.remove();
                } else {
                    console.log('[sendDashboardChat] No thinking indicator found to remove');
                }

                // Add assistant response
                console.log('[sendDashboardChat] Calling addChatMessage with result');
                addChatMessage('', 'assistant', result);
                conversationContext.messages.push({ role: 'assistant', content: JSON.stringify(result) });
                console.log('[sendDashboardChat] Message added to conversation context');
                
                // Track context for follow-up
                if (result.needsMoreInfo) {
                    conversationContext.lastIntent = 'waiting_for_info';
                } else if (result.action === 'created' || result.action === 'posted') {
                    conversationContext.lastIntent = null;
                    conversationContext.partialData = {};
                    // Refresh ALL data in real-time
                    await refreshAllData();
                } else if (result.matches) {
                    conversationContext.lastIntent = null;
                    conversationContext.partialData = {};
                    // Refresh for matches too
                    await refreshAllData();
                }

            } catch (error) {
                // Remove thinking indicator
                const thinkingIndicator = document.getElementById('thinking-indicator');
                if (thinkingIndicator) {
                    thinkingIndicator.parentElement.remove();
                }
                
                console.error('[sendDashboardChat] ===== ERROR CAUGHT =====');
                console.error('[sendDashboardChat] Error name:', error.name);
                console.error('[sendDashboardChat] Error message:', error.message);
                console.error('[sendDashboardChat] Full error:', error);
                
                let errorMessage = 'Something went wrong. Please try again.';
                let suggestion = 'Try posting shifts manually in the "New Shift" section, or use simpler queries.';
                
                if (error.name === 'AbortError') {
                    errorMessage = 'â±ï¸ Request timed out after 30 seconds. The AI service might be busy or slow to respond.';
                    suggestion = '<strong>Try:</strong> Wait a moment and try again, or use the "New Shift" section to post manually.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                // Add error message to chat
                const messagesContainer = document.getElementById('dashboardChatMessages');
                const errorWrapper = document.createElement('div');
                errorWrapper.className = 'chat-message-wrapper assistant';
                errorWrapper.innerHTML = `
                    <div class="chat-bubble error">
                        <div style="font-weight: 600; margin-bottom: 6px;">â ï¸ Error</div>
                        <div style="margin-bottom: 8px;">${errorMessage}</div>
                        <div style="font-size: 0.8125rem; padding-top: 8px; border-top: 1px solid #DC2626;">
                            ð¡ ${suggestion}
                        </div>
                    </div>
                `;
                messagesContainer.appendChild(errorWrapper);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                console.log('[sendDashboardChat] Error message displayed to user');
            } finally {
                input.disabled = false;
                input.focus();
                console.log('[sendDashboardChat] Input re-enabled and focused');
            }
        }

        function startVoiceInputDashboard() {
            const input = document.getElementById('dashboardChatInput');
            const voiceBtn = document.getElementById('voiceBtnDashboard');

            if (!('webkitSpeechRecognition' in window)) {
                alert('Voice input is not supported in your browser. Please use Chrome, Edge, or Safari.');
                return;
            }

            const recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            voiceBtn.classList.add('recording');
            voiceBtn.innerHTML = 'ð´ Recording...';
            isRecording = true;

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                input.value = transcript;
                voiceBtn.classList.remove('recording');
                voiceBtn.innerHTML = 'â Voice';
                isRecording = false;
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                voiceBtn.classList.remove('recording');
                voiceBtn.innerHTML = 'â Voice';
                isRecording = false;
            };

            recognition.onend = function() {
                voiceBtn.classList.remove('recording');
                voiceBtn.innerHTML = 'â Voice';
                isRecording = false;
            };

            recognition.start();
        }

        async function updateDashboardGraph() {
            const canvas = document.getElementById('coverageChart');
            if (!canvas || !canvas.getContext) {
                console.error('[Graph] Canvas not found!');
                return;
            }
            console.log('[Graph] Updating dashboard graph...');

            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            // Clear canvas
            ctx.clearRect(0, 0, width, height);

            // Fetch real shift data
            let totalRequests = 0;
            let totalMatched = 0;
            
            try {
                const response = await fetch(`${API_BASE}/api/list`);
                const shifts = await response.json();
                
                console.log('[Graph] Fetched shifts:', shifts.length);
                
                // Count requests vs matched - be flexible with note matching
                shifts.forEach(shift => {
                    console.log('[Graph] Checking shift:', shift.user, 'Notes:', shift.notes);
                    
                    if (shift.notes) {
                        const notes = shift.notes.toLowerCase();
                        // Match various forms of "seeking coverage"
                        if (notes.includes('seeking') || notes.includes('need') || notes.includes('cover me') || notes.includes('request')) {
                            totalRequests++;
                            console.log('[Graph] Counted as request');
                        } 
                        // Match various forms of "available to cover"
                        else if (notes.includes('available') || notes.includes('can cover') || notes.includes('offering')) {
                            totalMatched++;
                            console.log('[Graph] Counted as available');
                        }
                    }
                });
                
                console.log('[Graph] Total requests:', totalRequests, 'Total available:', totalMatched);
            } catch (error) {
                console.error('Failed to fetch shifts for graph:', error);
            }
            
            const successRate = totalRequests > 0 ? Math.round((totalMatched / totalRequests) * 100) : 0;

            document.getElementById('graphRequests').textContent = totalRequests;
            document.getElementById('graphCovered').textContent = totalMatched;
            document.getElementById('graphRate').textContent = successRate + '%';

            // Use REAL data only - no fake trends
            console.log('[Graph] Drawing bar chart with real data');
            
            const padding = 40;
            const barWidth = 80;
            const maxHeight = height - padding * 2;
            
            // If there's no data, show a message
            if (totalRequests === 0 && totalMatched === 0) {
                ctx.fillStyle = '#666666';
                ctx.font = '14px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No coverage data yet', width / 2, height / 2);
                return;
            }
            
            const maxValue = Math.max(totalRequests, totalMatched, 1);
            
            // Draw grid lines for reference
            ctx.strokeStyle = '#E5E7EB';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = padding + (maxHeight / 4) * i;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
            }
            
            // Draw Requests bar (red/orange)
            const requestsHeight = (totalRequests / maxValue) * maxHeight;
            const requestsX = width / 3 - barWidth / 2;
            const requestsY = height - padding - requestsHeight;
            
            ctx.fillStyle = '#DC2626';
            ctx.fillRect(requestsX, requestsY, barWidth, requestsHeight);
            
            // Draw label
            ctx.fillStyle = '#1A1A1A';
            ctx.font = 'bold 14px Inter, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Requests', requestsX + barWidth / 2, height - padding + 20);
            if (requestsHeight > 20) {
                ctx.fillStyle = 'white';
                ctx.fillText(totalRequests.toString(), requestsX + barWidth / 2, requestsY + 20);
            } else {
                ctx.fillStyle = '#1A1A1A';
                ctx.fillText(totalRequests.toString(), requestsX + barWidth / 2, requestsY - 10);
            }
            
            // Draw Available bar (green)
            const matchedHeight = (totalMatched / maxValue) * maxHeight;
            const matchedX = (width * 2) / 3 - barWidth / 2;
            const matchedY = height - padding - matchedHeight;
            
            ctx.fillStyle = '#10B981';
            ctx.fillRect(matchedX, matchedY, barWidth, matchedHeight);
            
            // Draw label
            ctx.fillStyle = '#1A1A1A';
            ctx.font = 'bold 14px Inter, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Available', matchedX + barWidth / 2, height - padding + 20);
            if (matchedHeight > 20) {
                ctx.fillStyle = 'white';
                ctx.fillText(totalMatched.toString(), matchedX + barWidth / 2, matchedY + 20);
            } else {
                ctx.fillStyle = '#1A1A1A';
                ctx.fillText(totalMatched.toString(), matchedX + barWidth / 2, matchedY - 10);
            }
            
            console.log('[Graph] Bar chart drawn successfully');
        }

        async function updateRecentActivity() {
            try {
                const response = await fetch(`${API_BASE}/api/list`);
                const shifts = await response.json();
                
                const container = document.getElementById('recentActivity');
                
                if (shifts.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">â</div>
                            <p>No recent activity yet</p>
                        </div>
                    `;
                    return;
                }

                // Show latest 5 shifts
                const recent = shifts.slice(0, 5);
                let html = '';
                
                recent.forEach(shift => {
                    const isCurrentUser = shift.user === currentUser.name;
                    const bgColor = isCurrentUser ? '#F9FAFB' : '#FFFFFF';
                    
                    // Determine status badge - flexible matching
                    let statusBadge = '';
                    if (shift.notes) {
                        const notes = shift.notes.toLowerCase();
                        if (notes.includes('seeking') || notes.includes('need') || notes.includes('cover me') || notes.includes('request')) {
                            statusBadge = '<span style="font-size: 0.75rem; background: #FED7AA; color: #C2410C; padding: 2px 8px; border-radius: 12px; margin-left: 8px;">Needs Cover</span>';
                        } else if (notes.includes('available') || notes.includes('can cover') || notes.includes('offering')) {
                            statusBadge = '<span style="font-size: 0.75rem; background: #BBF7D0; color: #15803D; padding: 2px 8px; border-radius: 12px; margin-left: 8px;">Available</span>';
                        }
                    }
                    
                    html += `
                        <div style="padding: 12px; background: ${bgColor}; border: 1px solid #E5E7EB; border-radius: 8px; margin-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 4px;">
                                <div>
                                    <span style="font-weight: 600; color: #1A1A1A;">${shift.user}</span>
                                    <span style="color: #666666; font-size: 0.875rem;"> - ${shift.role}</span>
                                    ${statusBadge}
                                </div>
                                ${isCurrentUser ? '<span style="font-size: 0.75rem; background: #1A1A1A; color: white; padding: 2px 8px; border-radius: 12px;">You</span>' : ''}
                            </div>
                            <div style="color: #666666; font-size: 0.875rem;">
                                ð ${shift.date} | â° ${shift.shift}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            } catch (error) {
                console.error('Failed to update recent activity:', error);
            }
        }

        // ======================================================================
        // AI CHAT INTERFACE
        // ======================================================================

        async function sendChatMessage() {
            // Determine which chat input is being used
            const input = document.getElementById('chatInput') || document.getElementById('chatInputAlt');
            if (!input) return;
            
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addChatMessageLegacy('user', message);
            input.value = '';
            
                // Show loading
                const loadingId = addChatMessageLegacy('assistant', 'Processing...');
            
            try {
                // Call AI to parse the message
                const response = await fetch(`${API_BASE}/api/parse-chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message }),
                });
                
                const result = await response.json();
                
                // Remove loading message
                document.getElementById(loadingId).remove();
                
                if (result.shiftData) {
                    // AI successfully parsed shift data
                    addChatMessageLegacy('assistant', `Got it! I'll post this shift for you:<br>
                        <strong>Name:</strong> ${result.shiftData.user}<br>
                        <strong>Role:</strong> ${result.shiftData.role}<br>
                        <strong>Date:</strong> ${result.shiftData.date}<br>
                        <strong>Time:</strong> ${result.shiftData.shift}`);
                    
                    // Auto-post the shift
                    await postShiftFromChat(result.shiftData);
                } else {
                    addChatMessageLegacy('assistant', result.reply || 'Could you provide more details? I need: your name, role, date, and time.');
                }
                } catch (error) {
                document.getElementById(loadingId).remove();
                addChatMessageLegacy('assistant', 'Sorry, I had trouble processing that. Please try the manual form below.');
            }
        }

        // Old chat function for AI Chat section (renamed to avoid conflict)
        function addChatMessageLegacy(type, content) {
            const container = document.getElementById('chatContainer') || document.getElementById('chatContainerAlt');
            if (!container) return 'msg-' + Date.now();
            
            const id = 'msg-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = `chat-message ${type}`;
            div.innerHTML = type === 'user' 
                ? `<strong>You:</strong> ${escapeHtml(content)}`
                : `<strong>AI:</strong> ${content}`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return id;
        }

        async function postShiftFromChat(shiftData) {
            try {
                const response = await fetch(`${API_BASE}/api/post`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(shiftData),
                });
                
                if (response.ok) {
                    addChatMessageLegacy('assistant', 'â Shift posted successfully! Check the "Open Shifts" section.');
                    refreshShifts();
                    updateAnalytics();
                } else {
                    addChatMessageLegacy('assistant', 'â Failed to post shift. Please use the manual form.');
                }
            } catch (error) {
                addChatMessageLegacy('assistant', 'â Network error. Please try the manual form.');
            }
        }

        // ======================================================================
        // VOICE INPUT
        // ======================================================================

        function startVoiceInput() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Voice input is not supported in your browser. Please use Chrome, Edge, or Safari.');
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            recognition.lang = 'en-US';
            recognition.continuous = false;
            recognition.interimResults = false;
            
            const voiceBtn = document.getElementById('voiceBtn') || document.getElementById('voiceBtnAlt');
            const chatInput = document.getElementById('chatInput') || document.getElementById('chatInputAlt');
            
            recognition.onstart = () => {
                isRecording = true;
                if (voiceBtn) {
                    voiceBtn.classList.add('recording');
                    voiceBtn.innerHTML = 'â Recording...';
                }
            };
            
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                if (chatInput) {
                    chatInput.value = transcript;
                }
                addChatMessageLegacy('user', `${transcript}`);
                sendChatMessage();
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                addChatMessageLegacy('assistant', 'Voice input failed. Please try typing instead.');
            };
            
            recognition.onend = () => {
                isRecording = false;
                if (voiceBtn) {
                    voiceBtn.classList.remove('recording');
                    voiceBtn.innerHTML = 'â Voice';
                }
            };
            
            recognition.start();
        }

        // Set default date to today
        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            const shiftDateField = document.getElementById('shiftDate');
            if (shiftDateField) {
                shiftDateField.value = today;
            }
        }

        // Post a new shift - wrap in DOMContentLoaded to ensure element exists
        document.addEventListener('DOMContentLoaded', () => {
            const postForm = document.getElementById('postForm');
            if (!postForm) return;
            
            postForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const btn = document.getElementById('postBtn');
                const originalText = btn.textContent;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Posting...';

            const data = {
                user: currentUser.name,
                role: document.getElementById('userRole').value.trim(),
                date: document.getElementById('shiftDate').value,
                shift: document.getElementById('shiftTime').value.trim(),
                notes: document.getElementById('shiftNotes').value.trim(),
            };

            try {
                const response = await fetch(`${API_BASE}/api/post`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('postMessage', 'Shift posted successfully!', 'success');
                    document.getElementById('postForm').reset();
                    setDefaultDate();
                    refreshShifts();
                } else {
                    showMessage('postMessage', result.error || 'Failed to post shift', 'error');
                }
            } catch (error) {
                showMessage('postMessage', 'Network error: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
            });
        });

        // Refresh shifts list
        async function refreshShifts() {
            const container = document.getElementById('shiftsList');
            if (!container) {
                console.log('[refreshShifts] Container not found, skipping');
                return;
            }
            container.innerHTML = '<div style="text-align: center; padding: 20px;">Loading...</div>';

            try {
                const response = await fetch(`${API_BASE}/api/list`);
                const shifts = await response.json();

                // Update analytics
                updateAnalytics();

                if (shifts.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ð­</div>
                            <p>No open shifts yet. Post one to get started!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = shifts.map(shift => `
                    <div class="shift-item">
                        <div class="shift-header">
                            <span class="shift-user">${escapeHtml(shift.user)}</span>
                            <span class="shift-role">${escapeHtml(shift.role)}</span>
                        </div>
                        <div class="shift-details">
                            <div class="shift-detail-row">
                                <span class="shift-detail-label">Date:</span> ${shift.date}
                            </div>
                            <div class="shift-detail-row">
                                <span class="shift-detail-label">Time:</span> ${escapeHtml(shift.shift)}
                            </div>
                            ${shift.notes ? `
                                <div class="shift-detail-row">
                                    <span class="shift-detail-label">Notes:</span> ${escapeHtml(shift.notes)}
                                </div>
                            ` : ''}
                            <div class="shift-detail-row" style="font-size: 0.85rem; color: #999;">
                                <span class="shift-detail-label">ID:</span> ${shift.id}
                            </div>
                        </div>
                        <div class="shift-actions">
                            <button onclick="requestMatch('${shift.id}')">
                                Find AI Match
                            </button>
                            <button class="btn-secondary" onclick="copyId('${shift.id}')">
                                Copy ID
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                container.innerHTML = `
                    <div class="error-message">
                        Failed to load shifts: ${error.message}
                    </div>
                `;
            }
        }

        // Request AI match
        async function requestMatch(requestId) {
            const card = document.getElementById('matchResultCard');
            const result = document.getElementById('matchResult');
            
            card.style.display = 'block';
            result.innerHTML = '<div style="text-align: center; padding: 20px;"><span class="loading"></span> AI is analyzing matches...</div>';
            
            // Scroll to result
            card.scrollIntoView({ behavior: 'smooth' });

            try {
                const response = await fetch(`${API_BASE}/api/match`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ requestId }),
                });

                const data = await response.json();

                if (response.ok && data.candidateUser) {
                    result.innerHTML = `
                        <div class="match-result">
                            <h3>Best Match Found</h3>
                            <div class="match-candidate">
                                ${escapeHtml(data.candidateUser)}
                            </div>
                            <div class="match-reason">
                                <strong>Why this match:</strong><br>
                                ${escapeHtml(data.reason)}
                            </div>
                            ${data.fallback ? '<p style="color: #856404; background: #fff3cd; padding: 10px; border-radius: 4px; margin-top: 10px;"><strong>Note:</strong> This suggestion was generated using a fallback method as the AI was unavailable.</p>' : ''}
                            <div>
                                <small>Request ID:</small><br>
                                <span class="copy-id" onclick="copyId('${requestId}')" title="Click to copy">
                                    ${requestId}
                                </span>
                            </div>
                        </div>
                    `;
                } else {
                    result.innerHTML = `
                        <div class="error-message">
                            ${escapeHtml(data.error || 'No match found')}
                        </div>
                    `;
                }
            } catch (error) {
                result.innerHTML = `
                    <div class="error-message">
                        Network error: ${escapeHtml(error.message)}
                    </div>
                `;
            }
        }

        // Copy ID to clipboard
        function copyId(id) {
            navigator.clipboard.writeText(id).then(() => {
                alert('ID copied to clipboard!');
            }).catch(() => {
                prompt('Copy this ID:', id);
            });
        }

        // Show message
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `
                <div class="${type === 'success' ? 'success-message' : 'error-message'}">
                    ${escapeHtml(message)}
                </div>
            `;
            setTimeout(() => {
                element.innerHTML = '';
            }, 5000);
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ======================================================================
        // ALTERNATIVE SECTION FUNCTIONS
        // ======================================================================

        // Refresh shifts for "All Shifts" section
        async function refreshShiftsAlt() {
            const container = document.getElementById('shiftsListAlt');
            if (!container) return;

            container.innerHTML = '<div style="text-align: center; padding: 20px;">Loading...</div>';

            try {
                const response = await fetch(`${API_BASE}/api/list`);
                const shifts = await response.json();

                if (shifts.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">â</div>
                            <p>No open shifts yet. Post one to get started!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = shifts.map(shift => `
                    <div class="shift-item">
                        <div class="shift-header">
                            <span class="shift-user">${escapeHtml(shift.user)}</span>
                            <span class="shift-role">${escapeHtml(shift.role)}</span>
                        </div>
                        <div class="shift-details">
                            <div class="shift-detail-row">
                                <span class="shift-detail-label">Date:</span> ${shift.date}
                            </div>
                            <div class="shift-detail-row">
                                <span class="shift-detail-label">Time:</span> ${escapeHtml(shift.shift)}
                            </div>
                            ${shift.notes ? `
                                <div class="shift-detail-row">
                                    <span class="shift-detail-label">Notes:</span> ${escapeHtml(shift.notes)}
                                </div>
                            ` : ''}
                            <div class="shift-detail-row" style="font-size: 0.85rem; color: #999;">
                                <span class="shift-detail-label">ID:</span> ${shift.id}
                            </div>
                        </div>
                        <div class="shift-actions">
                            <button onclick="requestMatch('${shift.id}')">
                                Find AI Match
                            </button>
                            <button class="btn-secondary" onclick="copyId('${shift.id}')">
                                Copy ID
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                container.innerHTML = `
                    <div class="error-message">
                        Failed to load shifts: ${error.message}
                    </div>
                `;
            }
        }

        // Update analytics for Analytics section
        async function updateAnalyticsAlt() {
            try {
                const response = await fetch(`${API_BASE}/api/list`);
                const shifts = await response.json();
                
                document.getElementById('statTotalAnalytics').textContent = shifts.length;
                document.getElementById('statOpenAnalytics').textContent = shifts.length;
                
                const matchesCount = Math.floor(shifts.length * 0.7);
                document.getElementById('statMatchesAnalytics').textContent = matchesCount;
                
                const roleCounts = {};
                shifts.forEach(shift => {
                    roleCounts[shift.role] = (roleCounts[shift.role] || 0) + 1;
                });
                const topRole = Object.keys(roleCounts).reduce((a, b) => 
                    roleCounts[a] > roleCounts[b] ? a : b, '-'
                );
                document.getElementById('statTopRoleAnalytics').textContent = topRole;
            } catch (error) {
                console.error('Analytics update failed:', error);
            }
        }

        // Handle alternative form submission
        document.addEventListener('DOMContentLoaded', () => {
            const formAlt = document.getElementById('postFormAlt');
            if (formAlt) {
                formAlt.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const data = {
                        user: currentUser.name,
                        role: document.getElementById('userRoleAlt').value.trim(),
                        date: document.getElementById('shiftDateAlt').value,
                        shift: document.getElementById('shiftTimeAlt').value.trim(),
                        notes: document.getElementById('shiftNotesAlt').value.trim(),
                    };

                    try {
                        const response = await fetch(`${API_BASE}/api/post`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data),
                        });

                    if (response.ok) {
                        showMessage('postMessageAlt', 'Shift posted successfully!', 'success');
                        formAlt.reset();
                        // Refresh ALL data in real-time
                        await refreshAllData();
                        updateAnalyticsAlt();
                        // Switch to dashboard to see the posted shift
                        setTimeout(() => navigateTo('dashboard'), 1000);
                    } else {
                            const result = await response.json();
                            showMessage('postMessageAlt', result.error || 'Failed to post shift', 'error');
                        }
                    } catch (error) {
                        showMessage('postMessageAlt', 'Network error: ' + error.message, 'error');
                    }
                });
            }

            // Set default date for alternative form
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('shiftDateAlt');
            if (dateInput) {
                dateInput.value = today;
            }
        });
    </script>
</body>
</html>

